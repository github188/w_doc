<!-- 请使用haroopd打开本文档 -->
<!-- http://pad.haroopress.com/user.html#download -->
#5.0 CSS Redis概要设计
[TOC]
###文档信息
作者: 邹俊龙
创建日期: 2015/12/17
修改日期: 2016/01/13
###评审纪要
####第一次评审
评审日期：2016/01/13
评审人员：邹俊龙、牟兴茂、杨怀志、蒋瑞欢、罗灿峰
会议纪要：
> domain/==moid==/confs变更为HASH，filed为会议E164，value为会议状态
> HDU暂时不动，后续重新评估设计
> 被恢复的会议不需要自动结会逻辑
> 归属于CSS的会议信息，重命名为confex/==e164==/
> 会议booktime归属修改为CSS

###1. Redis数据
####1.1. 会议列表
|类型     |KEY                         |FIELD    |说明      |归属   |
|--------|----------------------------|---------|----------|------|
|HASH    |confex/==e164==/            |cmu      |会议所属CMU|CSS   |
|HASH    |domain/==moid==/confs       |会议E164  |会议状态   |CSS   |

domain/moid/confs 中需要包括正在创建、正在召开和异常的会议（会管同步、License统计需要）

####1.2. Hdu信息（低优先级）
HDU外设信息由CSS（HDUPOOL？）上报Redis

|类型     |KEY                 |FIELD    |说明      |归属   |
|--------|--------------------|---------|----------|------|
|SET     |==moid==/hdus/      |         |域下的HDU  |CSS   |
|HASH    |hdu/==hdu_id==/     |issilence|是否静音   |CSS   |
|        |                    |volume   |音量      |      |
|        |                    |isused   |是否使用   |      |
|        |                    |isonline |是否在线   |      |
|        |                    |alias    |别名      |      |

####1.3. 监控信息
监控信息由CMU上报到Redis上，CSS根据此信息做监控心跳
START_PLAY_NTF保持原有逻辑

|类型     |KEY                  |FIELD    |说明      |归属   |
|--------|---------------------|---------|----------|------|
|SET     |conf/==e164==/monitor|         |ip:port   |DP    |

####1.4. 利旧MCU信息
|类型     |KEY                 |FIELD    |说明      |归属   |
|--------|--------------------|---------|---------|-------|
|SET     |cmus                |         |利旧CMUIP |CSS    |
|HASH    |cmu/==ip==          |mcuname  |别名      |CSS    |
|        |                    |mcutype  |类型      |       |
|        |                    |gkprefix |gk前缀    |       |
####1.5. 会议时间信息
会议信息中需要以下时间信息
1. 预定开启/结束时间（会管预约的时间，上报话单用）
2. 实际开启时间（会议实际开始时间，上报话单用）
3. 本次创会时间（会议恢复用）

|类型     |KEY                           |FIELD         |说明      |归属   |
|--------|------------------------------|--------------|----------|------|
|HASH    |confex/==e164==/              |realstarttime |创会时间   | CSS  |
|        |                              |booktime      |会议预约时间| CSS  |
|HASH    |conf/==e164==                 |starttime     |会议时间   | DP   |

####1.6. 域信息
|类型     |KEY                         |FIELD             |说明        |归属   |
|--------|----------------------------|------------------|------------|------|
|HASH    |domain/moid/statistic       |licensedconfnum   |授权会议数    |CSS   |
|        |                            |unlicensedconfnum |非授权会议数  |      |

####1.7. 预约会议信息（低优先级）
预约会议信息写入redis中
####1.8. 模板会议信息（低优先级）
模板会议信息写入redis中

###2.CSS架构调整
####2.1. 终端接入
终端接入不再发消息给VC获取会议列表、预约会议列表、会议模板及会议详情，直接从Redis上读取

会议列表所需接口（lua）：
1. 获取域中剩余会议数/总授权数
    其中不包括利旧会议
2. 获取域中当前已召开的会议列表
	如果是封闭会议，需要对受邀终端列表进行过滤
    支持过滤非公开会议
    参数：域名，是否过滤非公开会议，需过滤的终端别名
3. 获取会议详细信息
	参数：会议E164，域名
4. 判断会议是否存在
	参数：会议E164
5. 获取会议完整信息（恢复用）
	参数：会议E164
6. 根据E164获取公共会议模板
	参数：会议E164
7. 获取域中的公共会议模板
	支持过滤非公开会议
	参数：域名，是否过滤非公开会议
8. 获取会议结束时间（用于到时结会）

####2.2. 正常结会逻辑
结会时，MCU推送结会消息给DP，会议数据由DP先删除
CSS需要订阅Conf/e164 delete消息
CSS收到该delete消息后，再清除归属于CSS的会议相关数据
因DP在处理消息时，需要校验会议归属，若CSS先删除会议归属信息，会导致DP无法判定会议归属

####2.3. 非正常结会逻辑
非正常结会指会议非MCU结会逻辑（如，MCU不存在情况下结会）
CSS伪造结会消息推送给DP
后续逻辑与正常结会一致

####2.3. 会议恢复
废弃confinfodb数据库及相关代码，会议恢复数据从Redis获取
1. 获取某CMU下的所有会议E164
2. 修改会议状态为创建中
3. 修改会议所属MCU
4. 会议恢复时的数据清理，需由CMU在创会成功时清理（如CSS在创会时清理，则无法多次尝试恢复会议）

####2.4. 账号信息上报
删掉账号信息上报相关代码，目前无用，需要时再考虑如何实现

####2.5. 数据库依赖分离（低优先级）
1. 获取会议信息、会议列表
	可以由会管写入Redis，平台获取
2. 终端创会写数据库
	终端接入APP可将终端创会直接转换为会管API调用
    新版终端直接使用API创会
3. 终端修改会议持续时间
	CSS侧会做校验，确保延长的时间段内，会议数量未超过会议上线
4. 终端修改会议别名
5. 会议模板存储
	目前由CSS分配模板ID，并储存到数据库，会管读取该数据库
6. E164号分配
	目前由CSS分配，分配后再反向更新至会管数据库